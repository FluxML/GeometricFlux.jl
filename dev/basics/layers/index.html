<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Building Layers · GeometricFlux.jl</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-M61P0B2Y8E"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-M61P0B2Y8E', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://fluxml.ai/GeometricFlux.jl/stable/basics/layers/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/flux.css" rel="stylesheet" type="text/css"/><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="GeometricFlux.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">GeometricFlux.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/semisupervised_gcn/">Semi-Supervised Learning with GCN</a></li><li><a class="tocitem" href="../../tutorials/gcn_fixed_graph/">GCN with Fixed Graph</a></li><li><a class="tocitem" href="../../tutorials/gat/">Graph Attention Network</a></li><li><a class="tocitem" href="../../tutorials/deepset/">DeepSet for Digit Sum</a></li><li><a class="tocitem" href="../../tutorials/vgae/">Variational Graph Autoencoder</a></li><li><a class="tocitem" href="../../tutorials/graph_embedding/">Graph Embedding</a></li></ul></li><li><a class="tocitem" href="../../introduction/">Introduction</a></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../conv/">Graph Convolutions</a></li><li><a class="tocitem" href="../passgraph/">Graph Passing</a></li><li class="is-active"><a class="tocitem" href>Building Layers</a><ul class="internal"><li><a class="tocitem" href="#Applying-Layers"><span>Applying Layers</span></a></li><li><a class="tocitem" href="#Define-Your-Own-GNN-Layer"><span>Define Your Own GNN Layer</span></a></li></ul></li><li><a class="tocitem" href="../subgraph/">Subgraph</a></li><li><a class="tocitem" href="../neighborhood_graph/">Neighborhood graphs</a></li><li><a class="tocitem" href="../random_graph/">Random graphs</a></li><li><a class="tocitem" href="../batch/">Batch Learning</a></li></ul></li><li><a class="tocitem" href="../../cooperate/">Cooperate with Flux Layers</a></li><li><span class="tocitem">Abstractions</span><ul><li><a class="tocitem" href="../../abstractions/msgpass/">Message passing scheme</a></li><li><a class="tocitem" href="../../abstractions/gn/">Graph network block</a></li></ul></li><li><a class="tocitem" href="../../dynamicgraph/">Dynamic Graph Update</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../manual/featuredgraph/">FeaturedGraph</a></li><li><a class="tocitem" href="../../manual/conv/">Graph Convolutional Layers</a></li><li><a class="tocitem" href="../../manual/pool/">Graph Pooling Layers</a></li><li><a class="tocitem" href="../../manual/embedding/">Embeddings</a></li><li><a class="tocitem" href="../../manual/models/">Models</a></li><li><a class="tocitem" href="../../manual/linalg/">Linear Algebra</a></li><li><a class="tocitem" href="../../manual/neighborhood_graph/">Neighborhood graphs</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>Building Layers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Building Layers</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/FluxML/GeometricFlux.jl/blob/master/docs/src/basics/layers.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-Graph-Neural-Networks"><a class="docs-heading-anchor" href="#Building-Graph-Neural-Networks">Building Graph Neural Networks</a><a id="Building-Graph-Neural-Networks-1"></a><a class="docs-heading-anchor-permalink" href="#Building-Graph-Neural-Networks" title="Permalink"></a></h1><p>Building GNN is as simple as building neural network in Flux. The syntax here is the same as Flux. <code>Chain</code> is used to stack layers into a GNN. A simple example is shown here:</p><pre><code class="language-julia hljs">model = Chain(
    GCNConv(feat=&gt;h1),
    GCNConv(h1=&gt;h2, relu),
)</code></pre><p>In the example above, the feature dimension in first layer is mapped from <code>feat</code> to <code>h1</code>. In second layer, <code>h1</code> is then mapped to <code>h2</code>. Default activation function is given as <code>identity</code> if it is not specified by users.</p><p>The initialization function <code>GCNConv(...)</code> constructs a <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer. For most of the layer types in GeometricFlux, a layer can be initialized in two ways:</p><ul><li>GNN layer without graph: initializing <em>without</em> a predefined graph topology. This allows the layer to accept different graph topology.</li><li>GNN layer with static graph: initializing <em>with</em> a predefined graph topology, e.g. graph wrapped in <a href="../../manual/featuredgraph/#GraphSignals.FeaturedGraph"><code>FeaturedGraph</code></a>. This strategy is suitable for datasets where each input requires the same graph structure and it has better performance than variable graph strategy.</li></ul><p>The example above demonstrate the variable graph strategy. The equivalent GNN architecture but with static graph strategy is shown as following:</p><pre><code class="language-julia hljs">model = Chain(
    WithGraph(fg, GCNConv(feat=&gt;h1)),
    WithGraph(fg, GCNConv(h1=&gt;h2, relu)),
)</code></pre><article class="docstring"><header><a class="docstring-binding" id="GeometricFlux.WithGraph" href="#GeometricFlux.WithGraph"><code>GeometricFlux.WithGraph</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">WithGraph([g], layer; dynamic=nothing)</code></pre><p>Train GNN layers with static graph.</p><p><strong>Arguments</strong></p><ul><li><code>g</code>: If a <code>FeaturedGraph</code> is given, a fixed graph is used to train with.</li><li><code>layer</code>: A GNN layer.</li><li><code>dynamic</code>: If a function is given, it enables dynamic graph update by constructing</li></ul><p>dynamic graph through given function within layers.</p><p><strong>Example</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using GraphSignals, GeometricFlux

julia&gt; adj = [0 1 0 1;
              1 0 1 0;
              0 1 0 1;
              1 0 1 0];

julia&gt; fg = FeaturedGraph(adj);

julia&gt; gc = WithGraph(fg, GCNConv(1024=&gt;256))  # graph preprocessed by adding self loops
WithGraph(Graph(#V=4, #E=8), GCNConv(1024 =&gt; 256))

julia&gt; WithGraph(fg, Dense(10, 5))
Dense(10 =&gt; 5)      # 55 parameters

julia&gt; model = Chain(
           GCNConv(32=&gt;32),
           gc,
       );

julia&gt; WithGraph(fg, model)
Chain(
  WithGraph(
    GCNConv(32 =&gt; 32),                  # 1_056 parameters
  ),
  WithGraph(
    GCNConv(1024 =&gt; 256),               # 262_400 parameters
  ),
)         # Total: 4 trainable arrays, 263_456 parameters,
          # plus 2 non-trainable, 32 parameters, summarysize 1.006 MiB.</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/FluxML/GeometricFlux.jl/blob/0d9ba5d2854c8db20956a833ce158f2f8544b2b9/src/layers/graphlayers.jl#L8-L54">source</a></section></article><h2 id="Applying-Layers"><a class="docs-heading-anchor" href="#Applying-Layers">Applying Layers</a><a id="Applying-Layers-1"></a><a class="docs-heading-anchor-permalink" href="#Applying-Layers" title="Permalink"></a></h2><p>When using GNN layers, the general guidelines are:</p><ul><li>With static graph strategy: you should pass in a <span>$d \times n \times batch$</span> matrix for node features, and the layer maps node features <span>$\mathbb{R}^d \rightarrow \mathbb{R}^k$</span> then the output will be in matrix with dimensions <span>$k \times n \times batch$</span>. The same ostensibly goes for edge features but as of now no layer type supports outputting new edge features.</li><li>With variable graph strategy: you should pass in a <a href="../../manual/featuredgraph/#GraphSignals.FeaturedGraph"><code>FeaturedGraph</code></a>, the output will be also be a <a href="../../manual/featuredgraph/#GraphSignals.FeaturedGraph"><code>FeaturedGraph</code></a> with modified node (and/or edge) features. Add <code>node_feature</code> as the following entry in the Flux chain (or simply call <code>node_feature()</code> on the output) if you wish to subsequently convert them to matrix form.</li></ul><h2 id="Define-Your-Own-GNN-Layer"><a class="docs-heading-anchor" href="#Define-Your-Own-GNN-Layer">Define Your Own GNN Layer</a><a id="Define-Your-Own-GNN-Layer-1"></a><a class="docs-heading-anchor-permalink" href="#Define-Your-Own-GNN-Layer" title="Permalink"></a></h2><p>Customizing your own GNN layers are the same as defining a layer in Flux. You may want to check <a href="https://fluxml.ai/Flux.jl/stable/models/basics/#Building-Layers-1">Flux documentation</a> first.</p><p>To define a customized GNN layer, for example, we take a simple <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer as example here.</p><pre><code class="language-julia hljs">struct GCNConv &lt;: AbstractGraphLayer
    weight
    bias
    σ
end

@functor GCNConv</code></pre><p>We first should define a <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> type and let it be the subtype of <a href="#GeometricFlux.AbstractGraphLayer"><code>AbstractGraphLayer</code></a>. In this type, it holds parameters that a layer operate on. Don&#39;t forget to add <code>@functor</code> macro to <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> type.</p><pre><code class="language-julia hljs">(l::GCNConv)(Ã::AbstractMatrix, x::AbstractMatrix) = l.σ.(l.weight * x * Ã .+ l.bias)</code></pre><p>Then, we can define the operation for <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer.</p><pre><code class="language-julia hljs">function (l::GCNConv)(fg::AbstractFeaturedGraph)
    nf = node_feature(fg)
    Ã = Zygote.ignore() do
        GraphSignals.normalized_adjacency_matrix(fg, eltype(nf); selfloop=true)
    end
    return ConcreteFeaturedGraph(fg, nf = l(Ã, nf))
end</code></pre><p>Here comes to the GNN-specific behaviors. A GNN layer should accept object of subtype of <code>AbstractFeaturedGraph</code> to support variable graph strategy. A variable graph strategy should fetch node/edge/global features from <code>fg</code> and transform graph in <code>fg</code> into required form for layer operation, e.g. <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer needs a normalized adjacency matrix with self loop. Then, normalized adjacency matrix <code>Ã</code> and node features <code>nf</code> are pass through <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer <code>l(Ã, nf)</code> to give a new node feature. Finally, a <a href="../../manual/featuredgraph/#GraphSignals.ConcreteFeaturedGraph"><code>ConcreteFeaturedGraph</code></a> wrap graph in <code>fg</code> and new node features into a new object of subtype of <code>AbstractFeaturedGraph</code>.</p><pre><code class="language-julia hljs">layer = GCNConv(10=&gt;5, relu)
new_fg = layer(fg)
gradient(() -&gt; sum(node_feature(layer(fg))), Flux.params(layer))</code></pre><p>Now we complete a simple version of <a href="../../manual/conv/#GeometricFlux.GCNConv"><code>GCNConv</code></a> layer. One can test the forward pass and gradient if they work properly.</p><article class="docstring"><header><a class="docstring-binding" id="GeometricFlux.AbstractGraphLayer" href="#GeometricFlux.AbstractGraphLayer"><code>GeometricFlux.AbstractGraphLayer</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractGraphLayer</code></pre><p>An abstract type of graph neural network layer for GeometricFlux.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/FluxML/GeometricFlux.jl/blob/0d9ba5d2854c8db20956a833ce158f2f8544b2b9/src/layers/graphlayers.jl#L1-L5">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../passgraph/">« Graph Passing</a><a class="docs-footer-nextpage" href="../subgraph/">Subgraph »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.17 on <span class="colophon-date" title="Thursday 19 May 2022 19:14">Thursday 19 May 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
