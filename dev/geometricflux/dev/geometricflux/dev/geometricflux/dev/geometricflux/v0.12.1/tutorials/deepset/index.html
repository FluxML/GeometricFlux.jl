<!DOCTYPE html><HTML lang="en"><head><script charset="utf-8" src="../../../../../../../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><script charset="utf-8" src="../../../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../assets/__default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../assets/__default/flexsearch_integration.js" type="text/javascript"></script><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>DeepSet for Digit Sum · GeometricFlux.jl</title><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-M61P0B2Y8E"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-M61P0B2Y8E', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner="" src="../../assets/warner.js"></script><link href="https://fluxml.ai/GeometricFlux.jl/stable/tutorials/deepset/" rel="canonical"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script data-main="../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../assets/themeswap.js"></script><link href="../../assets/flux.css" rel="stylesheet" type="text/css"/><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../../../assets/__default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../assets/__default/flexsearch.css" rel="stylesheet" type="text/css"/><link href="../../../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/><link href="../../../../../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/><link href="../../../../../../../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../../../../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/></head><body><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link active nav-item" href="../../../../../../../../../">GeometricFlux</a><a class="nav-link nav-item" href="../../../../../../../../../../graphsignals/stable/">GraphSignals</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding"></div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link active nav-item" href="../../../../../../../">GeometricFlux</a><a class="nav-link nav-item" href="../../../../../../../../graphsignals/stable/">GraphSignals</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding"></div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link active nav-item" href="../../../../../">GeometricFlux</a><a class="nav-link nav-item" href="../../../../../../graphsignals/stable/">GraphSignals</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding"></div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><nav id="multi-page-nav"><div class="hidden-on-mobile" id="nav-items"><a class="nav-link active nav-item" href="../../../">GeometricFlux</a><a class="nav-link nav-item" href="../../../../graphsignals/">GraphSignals</a><div class="search nav-item"><input id="search-input" placeholder="Search..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding">/</div></div></div><a id="multidoc-toggler"></a></nav><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img alt="GeometricFlux.jl logo" src="../../assets/logo.svg"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">GeometricFlux.jl</a></span></div><form action="../../search/" class="docs-search"><input class="docs-search-query" id="documenter-search-query" name="q" placeholder="Search docs" type="text"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../semisupervised_gcn/">Semi-Supervised Learning with GCN</a></li><li><a class="tocitem" href="../gcn_fixed_graph/">GCN with Fixed Graph</a></li><li><a class="tocitem" href="../gat/">Graph Attention Network</a></li><li class="is-active"><a class="tocitem" href="">DeepSet for Digit Sum</a><ul class="internal"><li><a class="tocitem" href="#Step-1:-Load-MNIST-Dataset"><span>Step 1: Load MNIST Dataset</span></a></li><li><a class="tocitem" href="#Step-2:-Build-a-DeepSet-model"><span>Step 2: Build a DeepSet model</span></a></li><li><a class="tocitem" href="#Step-3:-Loss-Functions"><span>Step 3: Loss Functions</span></a></li><li><a class="tocitem" href="#Step-4:-Training-DeepSet-Model"><span>Step 4: Training DeepSet Model</span></a></li></ul></li><li><a class="tocitem" href="../vgae/">Variational Graph Autoencoder</a></li><li><a class="tocitem" href="../graph_embedding/">Graph Embedding</a></li></ul></li><li><a class="tocitem" href="../../introduction/">Introduction</a></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../../basics/conv/">Graph Convolutions</a></li><li><a class="tocitem" href="../../basics/passgraph/">Graph Passing</a></li><li><a class="tocitem" href="../../basics/layers/">Building Layers</a></li><li><a class="tocitem" href="../../basics/subgraph/">Subgraph</a></li><li><a class="tocitem" href="../../basics/neighborhood_graph/">Neighborhood graphs</a></li><li><a class="tocitem" href="../../basics/random_graph/">Random graphs</a></li><li><a class="tocitem" href="../../basics/batch/">Batch Learning</a></li></ul></li><li><a class="tocitem" href="../../cooperate/">Cooperate with Flux Layers</a></li><li><span class="tocitem">Abstractions</span><ul><li><a class="tocitem" href="../../abstractions/msgpass/">Message passing scheme</a></li><li><a class="tocitem" href="../../abstractions/gn/">Graph network block</a></li></ul></li><li><a class="tocitem" href="../../dynamicgraph/">Dynamic Graph Update</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../manual/featuredgraph/">FeaturedGraph</a></li><li><a class="tocitem" href="../../manual/conv/">Graph Convolutional Layers</a></li><li><a class="tocitem" href="../../manual/pool/">Graph Pooling Layers</a></li><li><a class="tocitem" href="../../manual/embedding/">Embeddings</a></li><li><a class="tocitem" href="../../manual/models/">Models</a></li><li><a class="tocitem" href="../../manual/linalg/">Linear Algebra</a></li><li><a class="tocitem" href="../../manual/neighborhood_graph/">Neighborhood graphs</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href="">DeepSet for Digit Sum</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">DeepSet for Digit Sum</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/FluxML/GeometricFlux.jl/blob/master/docs/src/tutorials/deepset.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a></div></header><article class="content" id="documenter-page"><h1 id="Predicting-Digits-Sum-from-DeepSet-model"><a class="docs-heading-anchor" href="#Predicting-Digits-Sum-from-DeepSet-model">Predicting Digits Sum from DeepSet model</a><a id="Predicting-Digits-Sum-from-DeepSet-model-1"></a><a class="docs-heading-anchor-permalink" href="#Predicting-Digits-Sum-from-DeepSet-model" title="Permalink"></a></h1><p>Digits sum is a task of summing up digits in images or text. This example demonstrates summing up digits in arbitrary number of MNIST images. To accomplish such task, DeepSet model is suitable for this task. DeepSet model is excellent at the task which takes a set of objects and reduces them into single object.</p><h2 id="Step-1:-Load-MNIST-Dataset"><a class="docs-heading-anchor" href="#Step-1:-Load-MNIST-Dataset">Step 1: Load MNIST Dataset</a><a id="Step-1:-Load-MNIST-Dataset-1"></a><a class="docs-heading-anchor-permalink" href="#Step-1:-Load-MNIST-Dataset" title="Permalink"></a></h2><p>Since a DeepSet model predicts the summation from a set of images, we have to prepare training dataset composed of a random-sized set of images and a summed result.</p><p>First, the whole dataset is loaded from MLDatasets.jl and then shuffled before generating training dataset.</p><pre><code class="language-julia hljs">train_X, train_y = MLDatasets.MNIST.traindata(Float32)
train_X, train_y = shuffle_data(train_X, train_y)</code></pre><p>The <code>generate_featuredgraphs</code> here generates a set of pairs which contains a <code>FeaturedGraph</code> and a summed number for prediction target. In a <code>FeaturedGraph</code>, an arbitrary number of MNIST images are collected as node features and corresponding nodes are collected in a graph without edges.</p><pre><code class="language-julia hljs">train_data = generate_featuredgraphs(train_X, train_y, num_train_examples, 1:train_max_length)</code></pre><p><code>num_train_examples</code> is the parameter for assigning how many training example to generate. <code>1:train_max_length</code> specifies the range of number of images to contained in one example.</p><h2 id="Step-2:-Build-a-DeepSet-model"><a class="docs-heading-anchor" href="#Step-2:-Build-a-DeepSet-model">Step 2: Build a DeepSet model</a><a id="Step-2:-Build-a-DeepSet-model-1"></a><a class="docs-heading-anchor-permalink" href="#Step-2:-Build-a-DeepSet-model" title="Permalink"></a></h2><p>A DeepSet takes a set of objects and outputs single object. To make a model accept a set of objects, the model input must be invariant to permutation. The DeepSet model is simply composed of two parts: <span>$\phi$</span> network and <span>$\rho$</span> network. </p><p class="math-container">\[Z = \rho ( \sum_{x_i \in \mathcal{V}} \phi (x_i) )\]</p><p><span>$\phi$</span> network embeds every images and they are summed up to be a single embedding. Permutation invariance comes from the use of summation. In general, a commutative binary operator can be used to reduce a set of embeddings into one embedding. Finally, <span>$\rho$</span> network decodes the embedding to a number.</p><pre><code class="language-julia hljs">ϕ = Chain(
    Dense(args.input_dim, args.hidden_dims[1], tanh),
    Dense(args.hidden_dims[1], args.hidden_dims[2], tanh),
    Dense(args.hidden_dims[2], args.hidden_dims[3], tanh),
)
ρ = Dense(args.hidden_dims[3], args.target_dim)
model = DeepSet(ϕ, ρ) |&gt; device</code></pre><h2 id="Step-3:-Loss-Functions"><a class="docs-heading-anchor" href="#Step-3:-Loss-Functions">Step 3: Loss Functions</a><a id="Step-3:-Loss-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Step-3:-Loss-Functions" title="Permalink"></a></h2><p>Mean absolute error is used as the loss function. Since the model outputs a <code>FeaturedGraph</code>, the prediction is placed as a global feature in <code>FeaturedGraph</code>.</p><pre><code class="language-julia hljs">function model_loss(model, batch)
    ŷ = vcat(map(x -&gt; global_feature(model(x[1])), batch)...)
    y = vcat(map(x -&gt; x[2], batch)...)
    return mae(ŷ, y)
end</code></pre><h2 id="Step-4:-Training-DeepSet-Model"><a class="docs-heading-anchor" href="#Step-4:-Training-DeepSet-Model">Step 4: Training DeepSet Model</a><a id="Step-4:-Training-DeepSet-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Step-4:-Training-DeepSet-Model" title="Permalink"></a></h2><pre><code class="language-julia hljs"># optimizer
opt = ADAM(args.η)

# parameters
ps = Flux.params(model)

# training
@info "Start Training, total $(args.epochs) epochs"
for epoch = 1:args.epochs
    @info "Epoch $(epoch)"

    for batch in train_loader
        train_loss, back = Flux.pullback(ps) do
            model_loss(model, batch |&gt; device)
        end
        test_loss = model_loss(model, test_loader, device)
        grad = back(1f0)
        Flux.Optimise.update!(opt, ps, grad)
    end
end</code></pre><p>For a complete example, please check <a href="https://github.com/FluxML/GeometricFlux.jl/blob/master/examples/digitsum_deepsets.jl">examples/digitsum_deepsets.jl</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../gat/">« Graph Attention Network</a><a class="docs-footer-nextpage" href="../vgae/">Variational Graph Autoencoder »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.17 on <span class="colophon-date" title="Saturday 21 May 2022 14:27">Saturday 21 May 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>